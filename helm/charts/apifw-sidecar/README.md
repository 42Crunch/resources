# apifw-sidecar

`apifw-sidecar` is a template chart to help bootstrap the [42Crunch](https://42crunch.com/) API Firewall container using a sidecar pattern on a [Kubernetes](http://kubernetes.io) cluster using the [Helm](https://helm.sh) package manager.

In examples/ you will find some example configurations. This `README.md` explains the chart usage using Pixi as the API to protect. The `examples/values-pixi.yaml` can be used also as a template to protect your own API.

This example uses autogenerated certificates. For a production deployment you want to use or generate SSL certificates.

.
├── Chart.yaml
├── examples
│   └── values-pixi.yaml
├── README.md
├── templates
│   ├── certs.yaml
│   ├── deployment.yaml
│   ├── _helpers.tpl
│   ├── NOTES.txt
│   ├── protection-token.yaml
│   ├── registry-access.yaml
│   └── service.yaml
└── values.yaml

## Requirements

- Registered user in the 42Crunch platform
- Helm >= 2.8.0
- Kubernetes >= 1.8

## Configuration

The default configuration parameters are listed in `values.yaml`.

The following table lists parameters that must be configured by the user, as they come without default values:

Parameter | Description | Default
--- | --- | ---
`API.image` | Container repo | `null`
`API.tag` | Container tag | `null`
`API.port` | Container listening port | `null`
`API_FW.protection_token` | Token obtained from [42Crunch](https://42crunch.com/) platform | `null`
`registry.username` | Username to access the registry | `null`
`registry.password` | Password to access the registry | `null`

## Installing

The command deploys `apifw-sidecar` on the Kubernetes cluster.  We also use the `examples/values-pixi.yaml` to describe *non-sensitive* information of the API we will protect.
Sensible value is gathered from environmental values (To simplify the usage). Please take care since are sensitive information.

The [configuration](#configuration) section lists all the parameters that can be configured during installation.

First we define the values we will use.

```sh
    PROTECTION_TOKEN=${StringObtainedFromThePlatform}
    REGISTRY_USERNAME=${RegistryUser}
    REGISTRY_PASSWORD=${RegistryPassword}
```

> **Tip**: A white space in front of a command makes bash to skip saving this values to the history.

After that we can deploy using the command:

```sh
    helm upgrade --install apifw-sidecar-pixi ./charts/apifw-sidecar/ \
      -f ./charts/apifw-sidecar/examples/values-pixi.yaml \
      --set registry.username=${REGISTRY_USERNAME} \
      --set registry.password=${REGISTRY_PASSWORD} \
      --set API_FW.protection_token=${PROTECTION_TOKEN}
```

## Uninstalling the Chart

To deletes the release and remove all the Kubernetes components associated with the chart and issue the command:

```sh
    helm delete --purge apifw-sidecar-pixi
```
